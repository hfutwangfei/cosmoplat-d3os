IMAGE_DIR ?= _output

.prepare-docker-build:
	@echo Preparing image files...
	@mkdir -p ${IMAGE_DIR}/docker
	@cp docker/Dockerfile ${IMAGE_DIR}/docker/
	@cp docker/backend-1.9.0.jar ${IMAGE_DIR}/docker/

# Identify the image that will be built and deployed.
IMAGE_ADDRESS ?= registry-edge.cosmoplat.com
IMAGE_PROJECT ?= kubesphere
IMAGE_NAME ?= data-analysis
IMAGE_VERSION ?= 20220929
IMAGE ?= ${IMAGE_ADDRESS}/${IMAGE_PROJECT}/${IMAGE_NAME}

CHART_VERSION ?= 0.3.0
CHART_NAME ?= data-analysis

# remove _output.
clean-image:
	rm -rf ${IMAGE_DIR}

# make docker-build: Build image into local docker daemon.
docker-build: .prepare-docker-build
	@echo Building image for Image Manager into local docker daemon...
	docker build --pull -t ${IMAGE}:${IMAGE_VERSION} ${IMAGE_DIR}/docker
	@rm -rf ${IMAGE_DIR}

# helm create
create-chart:
	helm create ${CHART_NAME}

SED_REPO ?= "s/repository:\ nginx/repository:\ ${IMAGE_ADDRESS}\/${IMAGE_PROJECT}\/${IMAGE_NAME}/g"
SED_TAG ?= "s/tag: \"\"/tag: \"${IMAGE_VERSION}\"/g"
PORT ?= 8081
SED_PORT ?= "s/port: 80/port: ${PORT}/g"
SED_DESC ?= "s/description: A Helm chart for Kubernetes/description: ${CHART_NAME}/g"
SED_CHART_VERSION ?= "s/version: 0.1.0/version: ${CHART_VERSION}/g"
CONTAINER_PORT ?= {{ .Values.service.port | default 80 }}
SED_CONTAINER_PORT ?= "s/containerPort: 80/containerPort: ${CONTAINER_PORT}/g"
# remove probes in deployment.yaml
SED_DELETE_PROBE :=
LIVENESS_PROBE ?= livenessProbe:
SED_DELETE_PROBE := /${LIVENESS_PROBE}/d
READINESS_PROBE ?= readinessProbe:
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${READINESS_PROBE}/d
PROBE_HTTP_GET ?= httpGet:
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${PROBE_HTTP_GET}/d
PROBE_PATH ?= path:\ \/
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${PROBE_PATH}/d
PROBE_PORT ?= port:\ http
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${PROBE_PORT}/d
# make sed-chart: modify chart information.
sed-chart:
	sed -i '' ${SED_REPO} ${CHART_NAME}/values.yaml
	sed -i '' ${SED_TAG} ${CHART_NAME}/values.yaml
	sed -i '' ${SED_PORT} ${CHART_NAME}/values.yaml
	sed -i '' ${SED_DESC} ${CHART_NAME}/Chart.yaml
	sed -i '' ${SED_CHART_VERSION} ${CHART_NAME}/Chart.yaml
	sed -i '' ${SED_CONTAINER_PORT} ${CHART_NAME}/templates/deployment.yaml
	sed -i '' "${SED_DELETE_PROBE}" ${CHART_NAME}/templates/deployment.yaml

# add env
ADD_DEPLOYMENT_ENV_BEFORE ?= imagePullPolicy:\ {{\ .Values.image.pullPolicy\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_BEFORE}
ADD_DEPLOYMENT_WAP ?= \\n
ADD_DEPLOYMENT_SPACE ?= ' '
ADD_DEPLOYMENT_SPACE_10 ?= '          '
ADD_DEPLOYMENT_SPACE_12 ?= '            '
ADD_DEPLOYMENT_SPACE_14 ?= '              '
ADD_DEPLOYMENT_ENV_ENV ?= env:
ADD_DEPLOYMENT_ENV_NAME ?= -\ name:
ADD_DEPLOYMENT_ENV_VALUE ?= value:
# env name:
MYSQL_USER ?= mysql_user
MYSQL_PASSWORD ?= mysql_password
MYSQL_IP_PORT ?= mysql_ip_port
MYSQL_DATABASE ?= mysql_database
MINIO_HOST ?= minio_host
MINIO_BUCKET ?= minio_bucket
DT_STUDIO_HOST ?= dt_studio_host
SHARE_ADDRESS_URL ?= share_address_url
REDIS_HOST ?= redis_host
REDIS_PORT ?= redis_port
REDIS_PASSWORD ?= redis_password
REDIS_DATABASE ?= redis_database

# env:
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_10}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_ENV}
# mysql_user
ADD_DEPLOYMENT_ENV_MYSQL_USER_NAME ?= ${MYSQL_USER}
ADD_DEPLOYMENT_ENV_MYSQL_USER_VALUE ?= {{\ .Values.env.${MYSQL_USER}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MYSQL_USER_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MYSQL_USER_VALUE}
# mysql_password
ADD_DEPLOYMENT_ENV_MYSQL_PASSWORD_NAME ?= ${MYSQL_PASSWORD}
ADD_DEPLOYMENT_ENV_MYSQL_PASSWORD_VALUE ?= {{\ .Values.env.${MYSQL_PASSWORD}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MYSQL_PASSWORD_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MYSQL_PASSWORD_VALUE}
# mysql_ip_port
ADD_DEPLOYMENT_ENV_MYSQL_IP_PORT_NAME ?= ${MYSQL_IP_PORT}
ADD_DEPLOYMENT_ENV_MYSQL_IP_PORT_VALUE ?= {{\ .Values.env.${MYSQL_IP_PORT}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MYSQL_IP_PORT_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MYSQL_IP_PORT_VALUE}
# mysql_database
ADD_DEPLOYMENT_ENV_MYSQL_DATABASE_NAME ?= ${MYSQL_DATABASE}
ADD_DEPLOYMENT_ENV_MYSQL_DATABASE_VALUE ?= {{\ .Values.env.${MYSQL_DATABASE}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MYSQL_DATABASE_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MYSQL_DATABASE_VALUE}
# minio_host
ADD_DEPLOYMENT_ENV_MINIO_HOST_NAME ?= ${MINIO_HOST}
ADD_DEPLOYMENT_ENV_MINIO_HOST_VALUE ?= {{\ .Values.env.${MINIO_HOST}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MINIO_HOST_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MINIO_HOST_VALUE}
# minio_bucket
ADD_DEPLOYMENT_ENV_MINIO_BUCKET_NAME ?= ${MINIO_BUCKET}
ADD_DEPLOYMENT_ENV_MINIO_BUCKET_VALUE ?= {{\ .Values.env.${MINIO_BUCKET}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MINIO_BUCKET_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_MINIO_BUCKET_VALUE}
# dt_studio_host
ADD_DEPLOYMENT_ENV_DT_STUDIO_HOST_NAME ?= ${DT_STUDIO_HOST}
ADD_DEPLOYMENT_ENV_DT_STUDIO_HOST_VALUE ?= {{\ .Values.env.${DT_STUDIO_HOST}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_DT_STUDIO_HOST_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_DT_STUDIO_HOST_VALUE}
# share_address_url
ADD_DEPLOYMENT_ENV_SHARE_ADDRESS_URL_NAME ?= ${SHARE_ADDRESS_URL}
ADD_DEPLOYMENT_ENV_SHARE_ADDRESS_URL_VALUE ?= {{\ .Values.env.${SHARE_ADDRESS_URL}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_SHARE_ADDRESS_URL_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_SHARE_ADDRESS_URL_VALUE}
# redis_host
ADD_DEPLOYMENT_ENV_REDIS_HOST_NAME ?= ${REDIS_HOST}
ADD_DEPLOYMENT_ENV_REDIS_HOST_VALUE ?= {{\ .Values.env.${REDIS_HOST}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_REDIS_HOST_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_REDIS_HOST_VALUE}
# redis_port
ADD_DEPLOYMENT_ENV_REDIS_PORT_NAME ?= ${REDIS_PORT}
ADD_DEPLOYMENT_ENV_REDIS_PORT_VALUE ?= {{\ .Values.env.${REDIS_PORT}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_REDIS_PORT_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_REDIS_PORT_VALUE}
# redis_password
ADD_DEPLOYMENT_ENV_REDIS_PASSWORD_NAME ?= ${REDIS_PASSWORD}
ADD_DEPLOYMENT_ENV_REDIS_PASSWORD_VALUE ?= {{\ .Values.env.${REDIS_PASSWORD}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_REDIS_PASSWORD_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_REDIS_PASSWORD_VALUE}
# redis_database
ADD_DEPLOYMENT_ENV_REDIS_DATABASE_NAME ?= ${REDIS_DATABASE}
ADD_DEPLOYMENT_ENV_REDIS_DATABASE_VALUE ?= {{\ .Values.env.${REDIS_DATABASE}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_REDIS_DATABASE_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_REDIS_DATABASE_VALUE}
# env in deployment
ADD_DEPLOYMENT_ENV ?= s/${ADD_DEPLOYMENT_ENV_BEFORE}/${ADD_DEPLOYMENT_ENV_AFTER}/g

ADD_VALUES_WAP ?= \\n
ADD_VALUES_SPACE ?= ' '
ADD_VALUES_SPACE_2 ?= '  '
ADD_VALUES_ENV_ENV ?= env:
ADD_VALUES_ENV_NAME_MYSQL_USER ?= ${MYSQL_USER}
ADD_VALUES_ENV_NAME_MYSQL_PASSWORD ?= ${MYSQL_PASSWORD}
ADD_VALUES_ENV_NAME_MYSQL_IP_PORT ?= ${MYSQL_IP_PORT}
ADD_VALUES_ENV_NAME_MYSQL_DATABASE ?= ${MYSQL_DATABASE}
ADD_VALUES_ENV_NAME_MINIO_HOST ?= ${MINIO_HOST}
ADD_VALUES_ENV_NAME_MINIO_BUCKET ?= ${MINIO_BUCKET}
ADD_VALUES_ENV_NAME_DT_STUDIO_HOST ?= ${DT_STUDIO_HOST}
ADD_VALUES_ENV_NAME_SHARE_ADDRESS_URL ?= ${SHARE_ADDRESS_URL}
ADD_VALUES_ENV_NAME_REDIS_HOST ?= ${REDIS_HOST}
ADD_VALUES_ENV_NAME_REDIS_PORT ?= ${REDIS_PORT}
ADD_VALUES_ENV_NAME_REDIS_PASSWORD ?= ${REDIS_PASSWORD}
ADD_VALUES_ENV_NAME_REDIS_DATABASE ?= ${REDIS_DATABASE}
# env:
ADD_VALUES_ENV := ''
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_DESC}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_ENV}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_MYSQL_USER}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_MYSQL_PASSWORD}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_MYSQL_IP_PORT}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_MYSQL_DATABASE}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_MINIO_HOST}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_MINIO_BUCKET}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_DT_STUDIO_HOST}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_SHARE_ADDRESS_URL}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_REDIS_HOST}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_REDIS_PORT}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_REDIS_PASSWORD}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_REDIS_DATABASE}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}

add-env:
	sed -i '' ${ADD_DEPLOYMENT_ENV} ${CHART_NAME}/templates/deployment.yaml
	echo ${ADD_VALUES_ENV} >> ${CHART_NAME}/values.yaml

# helm package
package-chart:
	helm package ${CHART_NAME}

chart: create-chart sed-chart add-env package-chart


clean-chart:
	rm -rf ${CHART_NAME}*