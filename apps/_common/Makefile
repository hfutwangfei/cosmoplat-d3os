# todo: to be added as image repository
#  such as "registry-edge.cosmoplat.com", with a IMAGE_PROJECT "d3os"
#  "harbor.etianneng.cn", with a IMAGE_PROJECT "iip"
#  "registry.cn-hangzhou.aliyuncs.com", with a IMAGE_PROJECT "wangfei-k8s"
IMAGE_ADDRESS ?= registry-edge.cosmoplat.com
# todo: to be added as image project
IMAGE_PROJECT ?= nginx
# todo: to be added as image name
IMAGE_NAME ?= nginx
# todo: to be added as image version, such as v0.1.0
# todo: ^[v]*(0|[1-9][0-9]*)(.(0|[1-9][0-9]*)){0,}$
IMAGE_VERSION ?= v0.1.1
# todo: to be added as helm chart version, such as 0.1.0
# todo: ^[v]*(0|[1-9][0-9]*)(.(0|[1-9][0-9]*)){0,2}$
CHART_VERSION ?= 0.1.1
# todo: to be added as helm chart project, it can be set same as IMAGE_NAME
CHART_NAME ?= nginx1
# todo: to be added as chart description, it can be set same as CHART_NAME
CHART_DESC ?= nginx

# helm create
create-chart:
	@helm create ${CHART_NAME}

# image repository address
SED_REPO ?= "s/repository:\ nginx/repository:\ ${IMAGE_ADDRESS}\/${IMAGE_PROJECT}\/${IMAGE_NAME}/g"
# image version
SED_TAG ?= "s/tag: \"\"/tag: \"${IMAGE_VERSION}\"/g"
# todo: server port
PORT ?= 80
SED_PORT ?= "s/port: 80/port: ${PORT}/g"
# helm chart description
SED_DESC ?= "s/description: A Helm chart for Kubernetes/description: ${CHART_DESC}/g"
# helm chart version
SED_CHART_VERSION ?= "s/version: 0.1.0/version: ${CHART_VERSION}/g"
# app version
SED_CHART_APP_VERSION ?= "s/appVersion: \"1.16.0\"/appVersion: \"${IMAGE_VERSION}\"/g"
# container port
CONTAINER_PORT ?= {{ .Values.service.port | default 80 }}
SED_CONTAINER_PORT ?= "s/containerPort: 80/containerPort: ${CONTAINER_PORT}/g"
# remove probes in deployment.yaml
SED_DELETE_PROBE :=
LIVENESS_PROBE ?= livenessProbe:
SED_DELETE_PROBE := /${LIVENESS_PROBE}/d
READINESS_PROBE ?= readinessProbe:
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${READINESS_PROBE}/d
PROBE_HTTP_GET ?= httpGet:
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${PROBE_HTTP_GET}/d
PROBE_PATH ?= path:\ \/
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${PROBE_PATH}/d
PROBE_PORT ?= port:\ http
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${PROBE_PORT}/d
# make sed-chart: modify chart information.
sed-chart:
	sed -i '' ${SED_REPO} ${CHART_NAME}/values.yaml
	sed -i '' ${SED_TAG} ${CHART_NAME}/values.yaml
	sed -i '' ${SED_PORT} ${CHART_NAME}/values.yaml
	sed -i '' ${SED_DESC} ${CHART_NAME}/Chart.yaml
	sed -i '' ${SED_CHART_VERSION} ${CHART_NAME}/Chart.yaml
	sed -i '' ${SED_CHART_APP_VERSION} ${CHART_NAME}/Chart.yaml
	sed -i '' ${SED_CONTAINER_PORT} ${CHART_NAME}/templates/deployment.yaml
	sed -i '' "${SED_DELETE_PROBE}" ${CHART_NAME}/templates/deployment.yaml

# add env
ADD_DEPLOYMENT_ENV_BEFORE ?= imagePullPolicy:\ {{\ .Values.image.pullPolicy\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_BEFORE}
ADD_DEPLOYMENT_WAP ?= \\n
ADD_DEPLOYMENT_SPACE ?= ' '
ADD_DEPLOYMENT_SPACE_10 ?= '          '
ADD_DEPLOYMENT_SPACE_12 ?= '            '
ADD_DEPLOYMENT_SPACE_14 ?= '              '
IF_ENV ?= {{-\ if\ .Values.env.enabled\ }}
WITH_ENV ?= {{-\ with\ .Values.env.values\ }}
TO_YAML_NINDENT_12 ?= {{-\ toYaml\ .\ \|\ nindent\ 12\ }}
END_ENV ?= {{-\ end\ }}
ADD_DEPLOYMENT_ENV_ENV ?= env:
ADD_DEPLOYMENT_ENV_NAME ?= -\ name:
ADD_DEPLOYMENT_ENV_VALUE ?= value:

ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_10}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${IF_ENV}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_10}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${WITH_ENV}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_10}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_ENV}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${TO_YAML_NINDENT_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_10}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${END_ENV}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_10}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${END_ENV}
# env in deployment
ADD_DEPLOYMENT_ENV ?= s/${ADD_DEPLOYMENT_ENV_BEFORE}/${ADD_DEPLOYMENT_ENV_AFTER}/g

add-env:
	sed -i '' ${ADD_DEPLOYMENT_ENV} ${CHART_NAME}/templates/deployment.yaml

# add `volumes` and `volumeMounts`
WAP ?= \\n
SPACE ?= ' '
SPACE_6  ?= '      '
SPACE_8  ?= '        '
SPACE_10 ?= '          '
SPACE_12 ?= '            '
IF_VOLUMES ?= {{-\ if\ .Values.volume.enabled\ }}
WITH_VOLUMES ?= {{-\ with\ .Values.volume.volumes\ }}
TO_YAML_NINDENT_8 ?= {{-\ toYaml\ .\ \|\ nindent\ 8\ }}
VOLUMES ?= volumes:
END_VOLUMES ?= {{-\ end\ }}
IF_VOLUME_MOUNTS ?= {{-\ if\ .Values.volume.enabled\ }}
WITH_VOLUME_MOUNTS ?= {{-\ with\ .Values.volume.volumeMounts\ }}
VOLUME_MOUNTS ?= volumeMounts:
TO_YAML_NINDENT_12 ?= {{-\ toYaml\ .\ \|\ nindent\ 12\ }}
# add deployment.yaml `volumes`
ADD_DEPLOYMENT_VOLUMES_BEFORE ?= {{-\ toYaml\ .Values.podSecurityContext\ \|\ nindent\ 8\ }}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_BEFORE}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${SPACE_6}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${IF_VOLUMES}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${SPACE_6}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${WITH_VOLUMES}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${SPACE_6}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${VOLUMES}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${SPACE_8}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${TO_YAML_NINDENT_8}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${SPACE_6}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${END_VOLUMES}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${SPACE_6}
ADD_DEPLOYMENT_VOLUMES_AFTER := ${ADD_DEPLOYMENT_VOLUMES_AFTER}${END_VOLUMES}
ADD_DEPLOYMENT_VOLUMES ?= s/${ADD_DEPLOYMENT_VOLUMES_BEFORE}/${ADD_DEPLOYMENT_VOLUMES_AFTER}/g
# add deployment.yaml `volumeMounts`
ADD_DEPLOYMENT_VOLUME_MOUNTS_BEFORE ?= {{-\ toYaml\ .Values.resources\ \|\ nindent\ 12\ }}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_BEFORE}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${SPACE_10}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${IF_VOLUME_MOUNTS}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${SPACE_10}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${WITH_VOLUME_MOUNTS}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${SPACE_10}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${VOLUME_MOUNTS}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${SPACE_12}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${TO_YAML_NINDENT_12}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${SPACE_10}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${END_VOLUMES}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${WAP}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${SPACE_10}
ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER := ${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}${END_VOLUMES}
ADD_DEPLOYMENT_VOLUME_MOUNTS ?= s/${ADD_DEPLOYMENT_VOLUME_MOUNTS_BEFORE}/${ADD_DEPLOYMENT_VOLUME_MOUNTS_AFTER}/g

SED_CM_NAME_AND_LABEL_APP ?= "s/{{ template \"nginx.fullname\" . }}/{{ template \"${CHART_NAME}.fullname\" . }}/g"

add-volume:
	sed -i '' ${ADD_DEPLOYMENT_VOLUMES} ${CHART_NAME}/templates/deployment.yaml
	sed -i '' ${ADD_DEPLOYMENT_VOLUME_MOUNTS} ${CHART_NAME}/templates/deployment.yaml
	mkdir ${CHART_NAME}/etc
	cp etc/* ${CHART_NAME}/etc/
	cat yamls/values.yaml >> ${CHART_NAME}/values.yaml
	cat yamls/cm.yaml >> ${CHART_NAME}/templates/cm.yaml
	sed -i '' ${SED_CM_NAME_AND_LABEL_APP} ${CHART_NAME}/templates/cm.yaml

# helm package
package-chart:
	helm package ${CHART_NAME}

chart: clean create-chart sed-chart add-env add-volume package-chart

clean:
	rm -rf ${CHART_NAME}*